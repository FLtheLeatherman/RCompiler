# 语义分析自动化测试脚本

## 概述

`run_sema1_tests.py` 是一个自动化测试脚本，用于验证 RCompiler 的语义分析功能是否符合预期结果。

## 功能特性

- **自动读取测试用例**: 从 `test/sema1_result.txt` 读取所有测试点
- **批量执行测试**: 使用 `run_test` 程序逐个测试每个测试点
- **结果比较**: 将测试结果与标准答案进行对比
- **详细报告**: 显示每个测试点的详细信息和总体统计
- **错误处理**: 完善的异常处理和超时机制

## 使用方法

```bash
# 在项目根目录下运行
python3 test/run_sema1_tests.py

# 或者直接执行（需要执行权限）
./test/run_sema1_tests.py
```

## 前置条件

1. 确保 `run_test` 程序已编译（在 `build/` 目录下）
2. 确保 `test/sema1_result.txt` 文件存在
3. 测试用例文件应位于 `.RCompiler-Testcases/semantic-1/src/<test_name>/<test_name>.rx`

## 输出格式

脚本会输出以下信息：

### 测试过程表格
```
测试点          标准结果   我的结果   一致性     状态
------------------------------------------------------------------
return1        失败      通过      ✗ 不一致    编译通过
return2        通过      通过      ✓ 一致     编译通过
...
```

### 统计结果
```
================================================================================
测试统计结果
================================================================================
总测试数量: 221
一致测试数量: 180
不一致测试数量: 41
一致率: 81.45%
```

## 结果解释

- **标准结果**: 来自 `sema1_result.txt` 的预期结果
  - `通过`: 预期编译成功（返回码 0）
  - `失败`: 预期编译失败（返回码 -1）

- **我的结果**: 实际测试结果
  - `通过`: 程序正常退出，无异常
  - `失败`: 程序抛出 runtime_error 或异常退出

- **一致性**: 测试结果是否与标准答案匹配
  - `✓ 一致`: 结果匹配
  - `✗ 不一致`: 结果不匹配

## 退出码

- `0`: 所有测试结果都与标准答案一致
- `1`: 存在测试结果与标准答案不一致的情况

## 技术细节

### 测试执行逻辑
1. 调用 `./run_test <test_name>` 执行测试
2. 监控程序退出码：
   - 退出码 = 0: 认为编译通过
   - 退出码 ≠ 0: 认为编译失败
3. 设置 30 秒超时限制
4. 捕获并处理各种异常情况

### 文件格式要求
- `sema1_result.txt`: 每行格式为 `test_name expected_result`
- 测试文件路径: `.RCompiler-Testcases/semantic-1/src/<test_name>/<test_name>.rx`

## 故障排除

### 常见问题

1. **找不到测试文件**
   ```
   错误: 找不到测试结果文件 test/sema1_result.txt
   ```
   解决: 确保在项目根目录运行脚本

2. **run_test 程序不存在**
   ```
   警告: 运行测试 xxx 时出错: [Errno 2] No such file or directory: './run_test'
   ```
   解决: 先编译项目 `cd build && make run_test`

3. **测试超时**
   ```
   警告: 测试 xxx 超时
   ```
   解决: 检查测试用例是否包含无限循环或复杂计算

## 自定义配置

可以通过修改脚本中的以下参数来自定义行为：

- `timeout=30`: 调整超时时间（秒）
- `cwd='build'`: 修改工作目录
- 输出格式和显示逻辑

## 示例输出

```
================================================================================
RCompiler 语义分析测试自动化脚本
================================================================================
读取到 221 个测试用例

测试点          标准结果   我的结果   一致性     状态
----------------------------------------------------------------------
return1        失败      通过      ✗ 不一致    编译通过
return2        通过      通过      ✓ 一致     编译通过
...
----------------------------------------------------------------------
================================================================================
测试统计结果
================================================================================
总测试数量: 221
一致测试数量: 180
不一致测试数量: 41
一致率: 81.45%

⚠️  有 41 个测试结果与标准答案不一致